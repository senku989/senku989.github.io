<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تسجيل الدخول — QBank</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Main stylesheet (keep your style.css as-is) -->
  <link rel="stylesheet" href="style.css">

  <style>
/* --- Layout tweaks requested --- */

/* center the auth card vertically and horizontally */
body.login-body {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 35px;
}

.auth-card {
  width: 60vw;              /* 90% من عرض الشاشة */
  max-width: 1100px;        /* حد أقصى على الشاشات الكبيرة */
  margin: 0 auto;
  box-sizing: border-box;
}

/* العناصر داخل الفورم */
.auth-card .form-content {
  width: 60%;        /* 60% من عرض البطاقة على الشاشات الكبيرة */
  margin: 0 auto;    /* توسيط المحتوى داخل البطاقة */
}

/* اجعل مجموعة الإدخال بعرض كامل */
.auth-card .input-group {
  display: flex;     /* مهم: يحافظ على الأيقونة بجانب الإنبت */
  width: 100%;
}

/* الأيقونة تبقى بحجمها الطبيعي */
.auth-card .input-group-text {
  flex: 0 0 auto;    /* لا تتمدد، تبقى بجانب الإنبت */
}

/* الإنبت يتمدد ليملأ باقي المساحة */
.auth-card .form-control {
  flex: 1 1 auto;
  width: auto;       /* يترك العرض للـ flex */
}

/* الأزرار والروابط بعرض كامل */
.auth-card button,
.auth-card .google-btn,
.auth-card .link-btn {
  width: 100%;
}

/* صف الروابط يبقى مرتبًا */
.auth-card .d-flex.justify-content-center.gap-2 {
  width: 100%;
}

/* link-like buttons with subtle background */
.link-btn {
  display: inline-block;
  background: rgba(13,110,253,0.06);
  color: var(--qbank-blue, #15557b);
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
  transition: background .15s ease, transform .08s ease;
  border: 1px solid rgba(13,110,253,0.06);
}
.link-btn:hover { background: rgba(13,110,253,0.10); transform: translateY(-1px); }

.app-link.style-btn {
  padding: 8px 10px;
  border-radius: 8px;
  display: inline-block;
  margin: 6px 4px;
  text-decoration: none;
  color: inherit;
}

.floating-whatsapp {
  position: fixed;
  bottom: 18px;
  right: 18px;
  z-index: 9999;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #fff;
  background: #25D366;
  box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  text-decoration: none;
}

.top-controls { position: fixed; top: 18px; left: 18px; display:flex; gap:8px; z-index:999; }
.control-btn { background:var(--card-bg, #fff); border:1px solid rgba(0,0,0,0.06); padding:8px 10px; border-radius:10px; cursor:pointer; }

/* responsive tweak */
@media (max-width: 480px) {
  .auth-card { 
    width: 90vw;           /* بعرض الشاشة بالكامل في الهواتف */
    max-width: 100vw;
    padding: 18px; 
  }
  .auth-card .form-content { width: 100%; }
  .top-controls { left: 10px; gap:6px; }
}
  </style>

</head>
<body class="login-body">
  <center>

  <!-- Top small controls -->
  <div class="top-controls" aria-hidden="true">
    <button id="backBtn" class="control-btn" title="العودة للرئيسية">الرئيسية</button>
    <button id="langBtn" class="control-btn" title="تبديل اللغة"><i class="fa-solid fa-language"></i></button>
    <button id="themeBtn" class="control-btn" title="الوضع الداكن/الفاتح"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
  </div>

  <!-- Auth card (structure kept same as your original) -->
  <div class="auth-card p-5 shadow-lg rounded-4">
    <div class="text-center mb-3">
      <img src="assets/images/qbank-logo.png" alt="QBank" class="logo-img mb-2">
      <h3 id="title" class="fw-bold">تسجيل الدخول</h3>
      <p id="subtitle" class="text-muted small-text">ادخل بريدك وكلمة المرور للمتابعة</p>
    </div>

    <form id="loginForm" autocomplete="on" novalidate>
      <div class="form-content">

        <div class="mb-3 input-group">
          <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
          <input id="email" type="email" class="form-control" placeholder="example@gmail.com" required>
        </div>

        <div class="mb-3 input-group">
          <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
          <input id="password" type="password" class="form-control" placeholder="••••••••" required>
        </div>

        <button id="loginBtn" type="submit" class="btn btn-primary w-100 rounded-pill fw-bold mb-3">
          <i class="fa-solid fa-right-to-bracket me-2"></i> <span id="loginBtnText">تسجيل الدخول</span>
        </button>

        <div class="d-flex justify-content-center mb-3 gap-2">
          <!-- styled as subtle filled buttons -->
          <a id="forgotLink" href="#" class="app-link style-btn link-btn" role="button">نسيت كلمة المرور؟</a>
          <button id="guestBtn" type="button" class="link-btn" title="تجربة كزائر">تجربة سريعة</button>
        </div>

        <button id="googleLoginBtn" type="button" class="google-btn w-100 mb-2">
          <img src="assets/images/google.png" alt="Google" style="width:22px"> <span id="googleText"> المتابعة عبر جوجل</span>
        </button>

        <p class="text-center mt-3 small-text">
          <span id="noAccountText">ليس لديك حساب؟</span>
          <a id="signupLink" href="signup.html" class="app-link fw-bold style-btn link-btn">إنشاء حساب</a>
        </p>

      </div>
    </form>

    <p id="err" style="color:#cc3333; text-align:center; margin-top:8px;"></p>
  </div>

  <!-- WhatsApp floating -->
  <a id="whatsapp" class="floating-whatsapp" href="https://wa.me/96891234567" target="_blank" title="دعم فني">
    <i class="fa-brands fa-whatsapp"></i>
  </a>

  <!-- Script: import firebase helpers and wire UI (single import only) -->
  <script type="module">
    import { initFirebase, loginWithEmail, loginWithGoogle, friendlyErrorMessage } from './firebase.js';

    // initialize firebase (safe)
    initFirebase();

    // elements
    const loginForm = document.getElementById('loginForm');
    const errEl = document.getElementById('err');
    const backBtn = document.getElementById('backBtn');
    const langBtn = document.getElementById('langBtn');
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');

    // translation strings
    const strings = {
      ar: {
        title: "تسجيل الدخول",
        subtitle: "ادخل بريدك وكلمة المرور للمتابعة",
        login: "تسجيل الدخول",
        google: " المتابعة عبر جوجل",
        noAccount: "ليس لديك حساب؟",
        forgot: "نسيت كلمة المرور؟",
        homePageBtn: "الرئيسية",
        createBtn: "إنشاء حساب",
        guest: "تجربة سريعة"
      },
      en: {
        title: "Login",
        subtitle: "Enter your email & password to continue",
        login: "Login",
        google: " Continue with Google",
        noAccount: "Don't have an account?",
        forgot: "Forgot password?",
        homePageBtn: "Home",
        createBtn: "Create account",
        guest: "Try as Guest"
      }
    };

    // helpers for theme/lang persistence
    function getSavedTheme(){ return localStorage.getItem('qbank-theme') || 'light'; }
    function getSavedLang(){ return localStorage.getItem('qbank-lang') || 'ar'; }

    function applyTheme(t) {
      if (t === 'dark') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
      // update icon safely
      try {
        if (document.body.classList.contains('dark-mode')) themeIcon.classList.replace('fa-moon','fa-sun');
        else themeIcon.classList.replace('fa-sun','fa-moon');
      } catch(e){}
    }

    function applyLang(l) {
      const s = strings[l] || strings.ar;
      document.getElementById('title').textContent = s.title;
      document.getElementById('subtitle').textContent = s.subtitle;
      document.getElementById('loginBtnText').textContent = s.login;
      document.getElementById('googleText').textContent = s.google;
      document.getElementById('noAccountText').textContent = s.noAccount;
      document.getElementById('signupLink').textContent = s.createBtn;
      document.getElementById('forgotLink').textContent = s.forgot;
      document.getElementById('backBtn').textContent = s.homePageBtn;
      const guestBtn = document.getElementById('guestBtn');
      if (guestBtn) guestBtn.textContent = s.guest;

      if (l === 'ar') {
        document.documentElement.lang='ar';
        document.documentElement.dir='rtl';
      } else {
        document.documentElement.lang='en';
        document.documentElement.dir='ltr';
      }
    }

    // init UI state
    applyTheme(getSavedTheme());
    applyLang(getSavedLang());

    // UI interactions
    themeBtn.addEventListener('click', () => {
      const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      localStorage.setItem('qbank-theme', next);
      applyTheme(next);
    });

    langBtn.addEventListener('click', () => {
      const next = (getSavedLang() === 'ar') ? 'en' : 'ar';
      localStorage.setItem('qbank-lang', next);
      applyLang(next);
    });

    backBtn.addEventListener('click', () => { window.location.href = 'index.html'; });

    // Form submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errEl.textContent = '';
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        errEl.textContent = 'الرجاء تعبئة البريد الإلكتروني وكلمة المرور';
        return;
      }

      // disable submit while processing
      const submitBtn = document.getElementById('loginBtn');
      submitBtn.disabled = true;
      submitBtn.classList.add('disabled');

      try {
        // loginWithEmail should register device and check limits server-side or in function
        const resp = await loginWithEmail(email, password);

        // If the implementation returns an object indicating device-limit problem, handle it:
        if (resp && resp.error === 'max-devices') {
          errEl.textContent = 'لقد تجاوزت الحد المسموح للأجهزة لباقتك. تواصل مع الدعم.';
          submitBtn.disabled = false;
          submitBtn.classList.remove('disabled');
          return;
        }

        // success -> redirect to dashboard (or subscription/payment logic)
        window.location.href = 'dashboard.html';
      } catch (err) {
        console.error(err);
        // friendlyErrorMessage supports error object or code
        errEl.textContent = friendlyErrorMessage(err) || 'حدث خطأ غير متوقع';
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('disabled');
      }
    });

    // Google login
    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
      errEl.textContent = '';
      const btn = document.getElementById('googleLoginBtn');
      btn.disabled = true;
      try {
        await loginWithGoogle();
        window.location.href = 'dashboard.html';
      } catch (err) {
        console.error(err);
        errEl.textContent = friendlyErrorMessage(err) || 'فشل تسجيل الدخول عبر جوجل';
      } finally {
        btn.disabled = false;
      }
    });

    // Guest quick button (optional flow: redirect to limited dashboard)
    document.getElementById('guestBtn').addEventListener('click', () => {
      // simple guest flow: store a flag and redirect
      sessionStorage.setItem('qbank-guest', '1');
      window.location.href = 'dashboard.html';
    });

  </script>
  </center>
</body>
</html>
