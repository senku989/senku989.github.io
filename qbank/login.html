<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تسجيل الدخول — QBank</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <link rel="stylesheet" href="style.css">

  <style>
body.login-body {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 35px;
  font-family: "Cairo", system-ui, sans-serif;
}

.auth-card {
  width: 60vw;
  max-width: 1100px;
  margin: 0 auto;
  box-sizing: border-box;
}

.auth-card .form-content { width: 60%; margin: 0 auto; }
.auth-card .input-group { display: flex; width: 100%; }
.auth-card .input-group-text { flex: 0 0 auto; }
.auth-card .form-control { flex: 1 1 auto; width: auto; }
.auth-card button, .auth-card .google-btn, .auth-card .link-btn { width: 100%; }
.auth-card .d-flex.justify-content-center.gap-2 { width: 100%; }

.link-btn {
  display: inline-block;
  background: rgba(13,110,253,0.06);
  color: var(--qbank-blue, #15557b);
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
  transition: background .15s ease, transform .08s ease;
  border: 1px solid rgba(13,110,253,0.06);
}
.link-btn:hover { background: rgba(13,110,253,0.10); transform: translateY(-1px); }

.app-link.style-btn { padding: 8px 10px; border-radius: 8px; display: inline-block; margin: 6px 4px; text-decoration: none; color: inherit; }

.floating-whatsapp {
  position: fixed; bottom: 18px; right: 18px; z-index: 9999;
  width: 60px; height: 60px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; color: #fff; background: #25D366;
  box-shadow: 0 6px 18px rgba(0,0,0,0.18); text-decoration: none;
}

.top-controls { position: fixed; top: 18px; left: 18px; display:flex; gap:8px; z-index:999; }
.control-btn { background:var(--card-bg,#fff); border:1px solid rgba(0,0,0,0.06); padding:8px 10px; border-radius:10px; cursor:pointer; }

@media (max-width: 700px) {
  .auth-card { width: 90vw; max-width: 100vw; padding: 18px; }
  .auth-card .form-content { width: 90%; }
  .top-controls { left: 10px; gap:6px; }
}

/* Popup notification */
.notify {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  min-width: 380px; max-width: 560px;
  border-radius: 16px;
  box-shadow: 0 14px 38px rgba(0,0,0,0.28);
  animation: popIn 220ms ease-out;
}
.notify.error { background: #dc3545; color: #fff; }
.notify .content {
  padding: 18px 22px 22px;
  position: relative;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: start;
}
.notify .msg { grid-column: 1 / -1; font-size: 1.05rem; line-height: 1.7; }
.notify .title { font-weight: 700; font-size: 1.1rem; }
.notify .close {
  align-self: start;
  border: none; background: rgba(255,255,255,0.18);
  color: #fff; width: 34px; height: 34px;
  border-radius: 10px; font-size: 18px; cursor: pointer;
}
.notify .close:hover { background: rgba(255,255,255,0.28); transform: translateY(-1px); }
@keyframes popIn {
  from { opacity: 0; transform: translate(-50%, calc(-50% + 12px)) scale(0.98); }
  to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
  </style>
</head>
<body class="login-body">
  <center>

  <div class="top-controls" aria-hidden="true">
    <button id="backBtn" class="control-btn">الرئيسية</button>
    <button id="langBtn" class="control-btn"><i class="fa-solid fa-language"></i></button>
    <button id="themeBtn" class="control-btn"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
  </div>

  <div class="auth-card p-5 shadow-lg rounded-4">
    <div class="text-center mb-3">
      <img src="assets/images/qbank-logo.png" alt="QBank" class="logo-img mb-2">
      <h3 id="title" class="fw-bold">تسجيل الدخول</h3>
      <p id="subtitle" class="text-muted small-text">ادخل بريدك وكلمة المرور للمتابعة</p>
    </div>

    <form id="loginForm" autocomplete="on" novalidate>
      <div class="form-content">
        <div class="mb-3 input-group">
          <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
          <input id="email" type="email" class="form-control" placeholder="example@gmail.com" required>
        </div>
        <div class="mb-3 input-group">
          <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
          <input id="password" type="password" class="form-control" placeholder="••••••••" required>
        </div>
        <button id="loginBtn" type="submit" class="btn btn-primary w-100 rounded-pill fw-bold mb-3">
          <i class="fa-solid fa-right-to-bracket me-2"></i> <span id="loginBtnText">تسجيل الدخول</span>
        </button>
        <div class="d-flex justify-content-center mb-3 gap-2">
          <a id="forgotLink" href="#" class="app-link style-btn link-btn">نسيت كلمة المرور؟</a>
          <button id="guestBtn" type="button" class="link-btn">تجربة سريعة</button>
        </div>
        <button id="googleLoginBtn" type="button" class="google-btn w-100 mb-2">
          <img src="assets/images/google.png" alt="Google" style="width:22px"> <span id="googleText"> المتابعة عبر جوجل</span>
        </button>
        <p class="text-center mt-3 small-text">
          <span id="noAccountText">ليس لديك حساب؟</span>
          <a id="signupLink" href="signup.html" class="app-link fw-bold style-btn link-btn">إنشاء حساب</a>
        </p>
      </div>
    </form>
  </div>

  <!-- Popup notification -->
  <div id="notify" class="notify error">
    <div class="content">
      <div class="title">خطأ</div>
      <button id="notifyClose" class="close">&times;</button>
      <div id="notifyMsg" class="msg"></div>
    </div>
  </div>

  <a id="whatsapp" class="floating-whatsapp" href="https://wa.me/+96891296616" target="_blank">
    <i class="fa-brands fa-whatsapp"></i>
  </a>

  <script type="module">
    import { initFirebase, loginWithEmail, loginWithGoogle, friendlyErrorMessage } from './firebase.js';
    initFirebase();

    const loginForm = document.getElementById('loginForm');
    const backBtn = document.getElementById('backBtn');
    const langBtn = document.getElementById('langBtn');
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');

    // Notification helpers
    const notifyEl = document.getElementById('notify');
    const notifyMsg = document.getElementById('notifyMsg');
    const notifyClose = document.getElementById('notifyClose');

    function showNotify(msg, type = 'error') {
      notifyMsg.textContent = msg;
      notifyEl.classList.remove('error');
      if (type === 'error') notifyEl.classList.add('error');
      notifyEl.style.display = 'block';
      try { notifyClose.focus(); } catch (e) {}
    }
    function hideNotify() {
      notifyEl.style.display = 'none';
      notifyMsg.textContent = '';
    }
    notifyClose.addEventListener('click', hideNotify);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideNotify(); });

    // translation strings
    const strings = {
      ar: {
        title: "تسجيل الدخول",
        subtitle: "ادخل بريدك وكلمة المرور للمتابعة",
        login: "تسجيل الدخول",
        google: " المتابعة عبر جوجل",
        noAccount: "ليس لديك حساب؟",
        forgot: "نسيت كلمة المرور؟",
        homePageBtn: "الرئيسية",
        createBtn: "إنشاء حساب",
        guest: "تجربة سريعة",
        errFill: "الرجاء تعبئة البريد الإلكتروني وكلمة المرور",
        errDevices: "لقد تجاوزت الحد المسموح للأجهزة لباقتك. تواصل مع الدعم.",
        errUnknown: "حدث خطأ غير متوقع",
        errGoogle: "فشل تسجيل الدخول عبر جوجل",
        errInvalidCredential: "بيانات الاعتماد غير صحيحة. تأكد من البريد وكلمة المرور أو جرّب إعادة تسجيل الدخول."
      },
      en: {
        title: "Login",
        subtitle: "Enter your email & password to continue",
        login: "Login",
        google: " Continue with Google",
        noAccount: "Don't have an account?",
        forgot: "Forgot password?",
        homePageBtn: "Home",
        createBtn: "Create account",
        guest: "Try as Guest",
        errFill: "Please enter your email and password",
        errDevices: "You exceeded the allowed devices for your plan. Please contact support.",
        errUnknown: "An unexpected error occurred",
        errGoogle: "Google sign-in failed",
        errInvalidCredential: "Invalid credential. Check your email/password or try signing in again."
      }
    };

    function getSavedTheme(){ return localStorage.getItem('qbank-theme') || 'light'; }
    function getSavedLang(){ return localStorage.getItem('qbank-lang') || 'ar'; }

    function applyTheme(t) {
      if (t === 'dark') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
      try {
        if (document.body.classList.contains('dark-mode')) themeIcon.classList.replace('fa-moon','fa-sun');
        else themeIcon.classList.replace('fa-sun','fa-moon');
      } catch(e){}
    }

    function applyLang(l) {
      const s = strings[l] || strings.ar;
      document.getElementById('title').textContent = s.title;
      document.getElementById('subtitle').textContent = s.subtitle;
      document.getElementById('loginBtnText').textContent = s.login;
      document.getElementById('googleText').textContent = s.google;
      document.getElementById('noAccountText').textContent = s.noAccount;
      document.getElementById('signupLink').textContent = s.createBtn;
      document.getElementById('forgotLink').textContent = s.forgot;
      document.getElementById('backBtn').textContent = s.homePageBtn;
      localStorage.setItem('qbank-lang', l);
      if (l === 'ar') { document.documentElement.lang='ar'; document.documentElement.dir='rtl'; }
      else { document.documentElement.lang='en'; document.documentElement.dir='ltr'; }
    }

    applyTheme(getSavedTheme());
    applyLang(getSavedLang());

    themeBtn.addEventListener('click', () => {
      const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      localStorage.setItem('qbank-theme', next);
      applyTheme(next);
    });
    langBtn.addEventListener('click', () => {
      const next = (getSavedLang() === 'ar') ? 'en' : 'ar';
      localStorage.setItem('qbank-lang', next);
      applyLang(next);
    });
    backBtn.addEventListener('click', () => { window.location.href = 'index.html'; });

    // Form submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideNotify();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const lang = getSavedLang(); const s = strings[lang];

      if (!email || !password) { showNotify(s.errFill); return; }

      const submitBtn = document.getElementById('loginBtn');
      submitBtn.disabled = true; submitBtn.classList.add('disabled');

      try {
        const resp = await loginWithEmail(email, password);
        if (resp && resp.error === 'max-devices') {
          showNotify(s.errDevices); submitBtn.disabled = false; submitBtn.classList.remove('disabled'); return;
        }
        window.location.href = 'dashboard.html';
      } catch (err) {
        console.error(err);
        if (err?.code === 'auth/invalid-credential' || String(err?.message).includes('auth/invalid-credential')) {
          showNotify(s.errInvalidCredential);
        } else {
          showNotify(friendlyErrorMessage(err) || s.errUnknown);
        }
      } finally {
        submitBtn.disabled = false; submitBtn.classList.remove('disabled');
      }
    });

    // Google login
    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
      hideNotify();
      const btn = document.getElementById('googleLoginBtn');
      btn.disabled = true;
      const lang = getSavedLang(); const s = strings[lang];
      try {
        await loginWithGoogle();
        window.location.href = 'dashboard.html';
      } catch (err) {
        console.error(err);
        if (err?.code === 'auth/invalid-credential' || String(err?.message).includes('auth/invalid-credential')) {
          showNotify(s.errInvalidCredential);
        } else {
          showNotify(friendlyErrorMessage(err) || s.errGoogle);
        }
      } finally { btn.disabled = false; }
    });

    // Guest quick button
    document.getElementById('guestBtn').addEventListener('click', () => {
      sessionStorage.setItem('qbank-guest', '1');
      window.location.href = 'dashboard.html';
    });
  </script>
  </center>
</body>

</html>
