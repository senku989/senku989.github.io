<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>QBank Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    body { background-color: #f8f9fa; }
    .card-option { transition: transform 0.2s; }
    .card-option:hover { transform: scale(1.03); }
    .navbar .nav-link, .dropdown-item, .navbar-brand,
    #menuToggle, #themeToggle, #logoutBtn { cursor: pointer; user-select: none; }
    .dark-mode { background-color: #121212; color: #eee; }
    .dark-mode .card { background-color: #1e1e1e; color: #eee; }
    .dark-mode .navbar { background-color: #222 !important; }
    .dark-mode .brand-name { color: #fff !important; }
    footer { background-color: #f1f1f1; }
    .dark-mode #menuToggle {color: #ddd;}
    .dark-mode footer { background-color: #222; color: #eee; }

    /* Popup */
    .popup-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .popup {
      background: #fff; border-radius: 12px; padding: 30px;
      width: 400px; max-width: 90%; text-align: center; position: relative;
    }
    .popup h4 { font-weight: bold; margin-bottom: 15px; }
    .popup .close-btn {
      position: absolute; top: 10px; right: 15px;
      font-size: 20px; cursor: pointer;
    }
    .dark-mode .popup { background: #333; color: #eee; }
    .dark-mode .popup .close-btn { color: #fff; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar bg-white shadow-sm px-3 py-2">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <a class="navbar-brand d-flex align-items-center gap-2" data-page="dashboard">
      <img src="assets/images/qbank-logo.png" width="40" height="40" alt="QBank Logo" />
      <span class="fw-bold fs-4 brand-name">QBank</span>
    </a>
    <ul class="d-none d-lg-flex nav gap-3">
      <li class="nav-item"><a class="nav-link fw-bold" data-page="dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
      <li class="nav-item"><a class="nav-link fw-bold" data-page="profile">Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</a></li>
      <li class="nav-item"><a class="nav-link fw-bold" data-page="results">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</a></li>
      <li class="nav-item"><a class="nav-link fw-bold" data-page="subscription">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</a></li>
    </ul>
    <div class="d-flex align-items-center gap-3 nav-actions">
      <button id="themeToggle" class="btn btn-light border rounded-circle p-2"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
      <a id="logoutBtn" class="btn btn-outline-danger rounded-pill">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      <button class="btn d-lg-none" id="menuToggle"><i class="fa-solid fa-bars fa-lg"></i></button>
      <div id="mobileMenu" class="dropdown-menu animate__animated">
        <a class="dropdown-item" data-page="dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a class="dropdown-item" data-page="profile">Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</a>
        <a class="dropdown-item" data-page="results">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</a>
        <a class="dropdown-item" data-page="subscription">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</a>
      </div>
    </div>
  </div>
</nav>

<!-- Main Content -->
<main id="content" class="container py-4"></main>

<!-- Footer -->
<footer class="text-center py-3 mt-5">
  <p>Â© 2025 QBank â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
  <a href="#" class="mx-2">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
  <a href="#" class="mx-2">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a>
  <a href="#" class="mx-2">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
</footer>

<!-- Popup -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup card shadow-sm p-4 text-center">
    <span class="close-btn" id="closePopup">&times;</span>
    <h4 class="fw-bold mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h4>
    <p id="planDetails"></p>
    <button id="payBtn" class="btn btn-primary rounded-pill mt-3">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
  </div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAdPFwWxQ1SbOTBUnHyJU9ji1CyHzluMUU",
  authDomain: "quizzes-8edd4.firebaseapp.com",
  projectId: "quizzes-8edd4",
  storageBucket: "quizzes-8edd4.firebasestorage.app",
  messagingSenderId: "567385584064",
  appId: "1:567385584064:web:bcef8d81c2e3db16e11825",
  measurementId: "G-EW7TGSHREG"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const content = document.getElementById("content");
const themeToggle = document.getElementById("themeToggle");
const themeIcon = document.getElementById("themeIcon");
const logoutBtn = document.getElementById("logoutBtn");
const menuToggle = document.getElementById("menuToggle");
const mobileMenu = document.getElementById("mobileMenu");
let menuOpen = false;

let userData = null;
let authUser = null;

// Helpers
function escapeHtml(str) {
  return String(str ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
function escapeAttr(str) {
  return escapeHtml(str).replace(/"/g, "&quot;");
}
function isSubscriptionActive(sub) {
  if (!sub) return false;
  if (sub.status !== "active") return false;
  if (!sub.endDate) return false;
  const now = new Date();
  const end = new Date(sub.endDate);
  return end.getTime() > now.getTime();
}

// Auth state
auth.onAuthStateChanged(async (user) => {
  if (user) {
    authUser = user;
    const snap = await db.ref("users/" + user.uid).get();
    const dbData = snap.exists() ? snap.val() : {};
    userData = dbData;

    userData.subscription = userData.subscription || {
      planName: "-", price: "-", startDate: "-", endDate: "-", status: "-"
    };
    userData.history = userData.history || {};

    const selectedPlan = localStorage.getItem("selectedPlan");
    const isSubscribed = isSubscriptionActive(userData.subscription);

    if (!isSubscribed && selectedPlan) {
      const popupOverlay = document.getElementById("popupOverlay");
      const planDetails = document.getElementById("planDetails");
      const closePopup = document.getElementById("closePopup");
      const payBtn = document.getElementById("payBtn");

      let planText = "";
      if (selectedPlan === "1") planText = "Ø¨Ø§Ù‚Ø© Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯ â€” 1 Ø±.Ø¹ / Ø´Ù‡Ø±";
      if (selectedPlan === "2") planText = "Ø¨Ø§Ù‚Ø© Ø¬Ù‡Ø§Ø²ÙŠÙ† â€” 1.200 Ø±.Ø¹ / Ø´Ù‡Ø± (Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ù‹Ø§)";
      if (selectedPlan === "3") planText = "Ø¨Ø§Ù‚Ø© 3 Ø£Ø¬Ù‡Ø²Ø© â€” 1.400 Ø±.Ø¹ / Ø´Ù‡Ø±";

      planDetails.textContent = planText;
      popupOverlay.style.display = "flex";

      closePopup.addEventListener("click", () => {
        popupOverlay.style.display = "none";
      });

            payBtn.addEventListener("click", () => {
        popupOverlay.style.display = "none";
        // Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù†
        loadPage("subscription");
      });
    }

    loadPage("dashboard"); // Ø£ÙˆÙ„ ØµÙØ­Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  } else {
    window.location.href = "login.html";
  }
});

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª
function loadPage(page) {
  if (!userData) return;
  content.classList.add("animate__animated", "animate__fadeOut");
  setTimeout(() => {
    if (page === "dashboard") {
      const locked = !isSubscriptionActive(userData.subscription);
      content.innerHTML = `
        <h2 class="fw-bold mb-4">Ù…Ø±Ø­Ø¨Ù‹Ø§ ${escapeHtml(userData.name)} ğŸ‘‹</h2>
        <div class="row g-4">
          <div class="col-md-6">
            <div class="card card-option shadow-sm p-4 text-center">
              <i class="fa-solid fa-book-open fa-3x mb-3 text-primary"></i>
              <h5 class="fw-bold">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h5>
              <button class="btn btn-primary rounded-pill" ${locked ? "disabled" : ""}>
                ${locked ? "Ù…ØºÙ„Ù‚ Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ùƒ" : "Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©"}
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card card-option shadow-sm p-4 text-center">
              <i class="fa-solid fa-pen-to-square fa-3x mb-3 text-success"></i>
              <h5 class="fw-bold">Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ</h5>
              <button class="btn btn-success rounded-pill" ${locked ? "disabled" : ""}>
                ${locked ? "Ù…ØºÙ„Ù‚ Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ùƒ" : "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    if (page === "profile") {
      content.innerHTML = `
        <h2 class="fw-bold mb-4">Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
        <div class="card p-4 shadow-sm text-center">
          <h4>${escapeHtml(userData.name)}</h4>
          <p>${escapeHtml(userData.email || "-")}</p>
          <hr>
          <h5 class="fw-bold">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h5>
          <p>Ø§Ù„Ø¨Ø§Ù‚Ø©: ${escapeHtml(userData.subscription.planName)}</p>
          <p>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${escapeHtml(userData.subscription.endDate)}</p>
          <p>Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(userData.subscription.status)}</p>
        </div>
      `;
    }

    if (page === "subscription") {
      const currentPlan = userData.subscription.devicesAllowed || 0;
      content.innerHTML = `
        <h2 class="fw-bold mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
        <div class="card p-4 shadow-sm">
          <p>Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${escapeHtml(userData.subscription.planName)}</p>
          <p>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§: ${escapeHtml(currentPlan)}</p>
          <p>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${escapeHtml(userData.subscription.endDate)}</p>
          <p>Ø§Ù„Ø­Ø§Ù„Ø©: ${isSubscriptionActive(userData.subscription) ? "ÙØ¹Ù‘Ø§Ù„" : "ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ / Ù…Ù†ØªÙ‡ÙŠ"}</p>
          <hr>
          <h5 class="fw-bold mb-3">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø©</h5>
          <div class="d-flex flex-column gap-2">
            <label><input type="radio" name="plan" value="1" ${currentPlan===1?"checked":""}> Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯ â€” 1 Ø±.Ø¹ / Ø´Ù‡Ø±</label>
            <label><input type="radio" name="plan" value="2" ${currentPlan===2?"checked":""}> Ø¬Ù‡Ø§Ø²ÙŠÙ† â€” 1.200 Ø±.Ø¹ / Ø´Ù‡Ø±</label>
            <label><input type="radio" name="plan" value="3" ${currentPlan===3?"checked":""}> 3 Ø£Ø¬Ù‡Ø²Ø© â€” 1.400 Ø±.Ø¹ / Ø´Ù‡Ø±</label>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button id="requestChangePlan" class="btn btn-primary rounded-pill">ØªÙØ¹ÙŠÙ„ / ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
            <button id="cancelAutoRenew" class="btn btn-outline-danger rounded-pill">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          </div>
        </div>
      `;

      document.getElementById("requestChangePlan").addEventListener("click", () => {
        const selected = document.querySelector('input[name="plan"]:checked').value;
        localStorage.setItem("selectedPlan", selected);
        alert("Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.");
      });
      document.getElementById("cancelAutoRenew").addEventListener("click", () => {
        alert("Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±.");
      });
    }

    content.classList.remove("animate__fadeOut");
    content.classList.add("animate__fadeIn");
    setTimeout(() => content.classList.remove("animate__animated", "animate__fadeIn"), 500);
  }, 300);
}

// Theme toggle
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    themeIcon.classList.replace("fa-moon", "fa-sun");
    localStorage.setItem("qbank-theme", "dark");
  } else {
    themeIcon.classList.replace("fa-sun", "fa-moon");
    localStorage.setItem("qbank-theme", "light");
  }
});

// Mobile menu toggle
menuToggle.addEventListener("click", () => {
  if (!menuOpen) {
    mobileMenu.classList.add("show", "animate__fadeInDown");
    menuOpen = true;
  } else {
    mobileMenu.classList.remove("animate__fadeInDown");
    mobileMenu.classList.add("animate__fadeOutUp");
    setTimeout(() => {
      mobileMenu.classList.remove("show", "animate__fadeOutUp");
      menuOpen = false;
    }, 300);
  }
});

// Logout
logoutBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (user) {
    await auth.signOut();
    window.location.href = "login.html";
  }
});
</script>
</body>
</html>