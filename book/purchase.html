<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إتمام الشراء - كتاب 1000$ شهريًا</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    
    <!-- Payhip -->
    <script type="text/javascript" src="https://payhip.com/payhip.js"></script>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- الأنماط -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body class="purchase-page">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="purchase-container">
                    <!-- توجيه المستخدم المسجل الدخول -->
                    <div id="loginPrompt" class="alert alert-info d-none">
                        <i class="bi bi-info-circle"></i>
                        <strong>ملاحظة مهمة:</strong> يجب أن تكون مسجلاً الدخول أولاً قبل الشراء.
                        <a href="login.html" class="alert-link">سجل الدخول من هنا</a>
                    </div>
                    
                    <!-- خطوات الشراء -->
                    <div class="purchase-steps mb-5">
                        <div class="step active">
                            <div class="step-number">1</div>
                            <div class="step-label">مراجعة الطلب</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-label">الدفع عبر Payhip</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-label">التأكيد والتنشيط</div>
                        </div>
                    </div>
                    
                    <!-- تفاصيل الطلب -->
                    <div class="order-summary card mb-4">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <i class="bi bi-journal-bookmark-fill text-primary" style="font-size: 3rem;"></i>
                                <h3 class="mt-3">كتاب 1000$ شهريًا</h3>
                                <p class="text-muted">النسخة الرقمية الكاملة</p>
                            </div>
                            
                            <div class="product-item mb-4">
                                <div class="product-info">
                                    <h5>الطريق العملي إلى 1000$ شهريًا</h5>
                                    <p class="text-muted">الإصدار الأول 2026 - أمجد الكلباني</p>
                                </div>
                                <div class="product-price">
                                    <span class="original-price">39$</span>
                                    <span class="current-price">19$</span>
                                </div>
                            </div>
                            
                            <div class="product-features">
                                <h6 class="mb-3"><i class="bi bi-check-circle-fill text-success"></i> ما تحصل عليه:</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <i class="bi bi-file-text"></i> 70+ صفحة متقدمة
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <i class="bi bi-journals"></i> 7 فصول متكاملة
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <i class="bi bi-arrow-clockwise"></i> تحديثات مجانية لسنة
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <i class="bi bi-download"></i> قوالب عملية للتحميل
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <i class="bi bi-headset"></i> دعم فني متخصص
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <i class="bi bi-shield-check"></i> ضمان استرداد 30 يوم
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تفاصيل السعر -->
                    <div class="order-total card mb-4">
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td>سعر الكتاب:</td>
                                        <td class="text-end">
                                            <span class="original-price text-muted text-decoration-line-through">39$</span>
                                            <span class="current-price fw-bold">19$</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>الخصم:</td>
                                        <td class="text-end text-success fw-bold">-20$ (50%)</td>
                                    </tr>
                                    <tr class="total-row">
                                        <td><strong>المجموع:</strong></td>
                                        <td class="text-end">
                                            <div class="total-amount">
                                                <span class="final-price">19$</span>
                                                <small class="text-muted d-block">شامل جميع الضرائب</small>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- طرق الدفع -->
                    <div class="payment-methods card mb-4">
                        <div class="card-body">
                            <h4 class="card-title mb-4"><i class="bi bi-credit-card"></i> طريقة الدفع</h4>
                            <p class="text-muted mb-4">نستخدم نظام Payhip الآمن لمعالجة المدفوعات</p>
                            
                            <!-- مزايا Payhip -->
                            <div class="payment-security mb-4">
                                <div class="row text-center">
                                    <div class="col-md-4 mb-3">
                                        <i class="bi bi-shield-check text-success" style="font-size: 1.5rem;"></i>
                                        <p class="mb-0"><small>معاملات آمنة</small></p>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <i class="bi bi-credit-card text-primary" style="font-size: 1.5rem;"></i>
                                        <p class="mb-0"><small>بطاقات متعددة</small></p>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <i class="bi bi-globe text-info" style="font-size: 1.5rem;"></i>
                                        <p class="mb-0"><small>مدفوعات عالمية</small></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payhip Button Container -->
                            <div id="payhipButtonContainer" class="text-center">
                                <div class="payhip-loading mb-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                    <p class="text-muted mt-2">جاري تحميل بوابة الدفع الآمنة...</p>
                                </div>
                                
                                <!-- سيتم إضافة زر Payhip هنا بالجافاسكريبت -->
                            </div>
                            
                            <!-- معلومات الدفع البديل -->
                            <div class="payment-note text-center mt-4">
                                <p class="text-muted">
                                    <small>
                                        <i class="bi bi-info-circle"></i>
                                        بعد الدفع، سيتم تفعيل حسابك تلقائياً خلال 2-3 دقائق
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ضمان الاسترداد -->
                    <div class="guarantee-card card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center">
                                    <i class="bi bi-shield-check guarantee-icon"></i>
                                </div>
                                <div class="col-md-10">
                                    <h5>ضمان استرداد الأموال لمدة 30 يوم</h5>
                                    <p class="text-muted mb-0">إذا لم تحقق قيمة من الكتاب خلال 30 يوم، سنعيد لك كامل المبلغ بدون أي أسئلة.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- الأسئلة الشائعة -->
                    <div class="faq-card card mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-4"><i class="bi bi-question-circle"></i> أسئلة شائعة</h5>
                            
                            <div class="accordion" id="faqAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                            متى سأحصل على الكتاب بعد الدفع؟
                                        </button>
                                    </h2>
                                    <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            فوراً! بعد إتمام الدفع عبر Payhip، سيتم تفعيل حسابك تلقائياً ويمكنك البدء بالقراءة مباشرة.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                            هل الدفع آمن؟
                                        </button>
                                    </h2>
                                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            نعم، نستخدم Payhip لمعالجة المدفوعات وهي خدمة آمنة ومعتمدة عالمياً.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- رسالة التحميل -->
                    <div id="purchaseMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="firebase-config.js"></script>
    <script src="script.js"></script>
    
    <script>
        // متغيرات
        let currentUser = null;
        
        // التحقق من حالة المستخدم عند التحميل
        document.addEventListener('DOMContentLoaded', async function() {
            currentUser = await firebaseAuth.getCurrentUser();
            
            if (!currentUser) {
                // عرض رسالة تسجيل الدخول
                document.getElementById('loginPrompt').classList.remove('d-none');
            } else {
                // تحميل زر Payhip بعد تأكيد تسجيل الدخول
                loadPayhipButton();
            }
        });
        
        // تحميل زر Payhip
        function loadPayhipButton() {
            const container = document.getElementById('payhipButtonContainer');
            
            // إنشاء زر Payhip
            const payhipButton = document.createElement('a');
            payhipButton.href = 'https://payhip.com/b/4K0bD';
            payhipButton.className = 'payhip-buy-button';
            payhipButton.setAttribute('data-theme', 'green');
            payhipButton.setAttribute('data-product', '4K0bD');
            payhipButton.innerHTML = `
                <i class="bi bi-cart3"></i> إتمام الشراء بمبلغ 19$
            `;
            
            // إضافة الأنماط
            payhipButton.style.cssText = `
                display: inline-block;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                text-decoration: none;
                font-weight: 600;
                font-size: 1.1rem;
                border: none;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            `;
            
            // إضافة تأثير hover
            payhipButton.onmouseover = function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 6px 20px rgba(16, 185, 129, 0.4)';
            };
            
            payhipButton.onmouseout = function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 15px rgba(16, 185, 129, 0.3)';
            };
            
            // إضافة حدث النقر
            payhipButton.onclick = async function(e) {
                e.preventDefault();
                
                // التحقق من حالة المستخدم قبل المتابعة
                const user = await firebaseAuth.getCurrentUser();
                if (!user) {
                    showMessage('error', 'يجب تسجيل الدخول أولاً');
                    window.location.href = 'login.html';
                    return;
                }
                
                // حفظ معرف المعاملة في LocalStorage
                const transactionId = 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('pending_transaction', JSON.stringify({
                    transactionId: transactionId,
                    userId: user.uid,
                    timestamp: new Date().toISOString(),
                    amount: 19,
                    product: 'book_1000_monthly'
                }));
                
                // فتح صفحة Payhip في نافذة جديدة
                window.open(
                    'https://payhip.com/b/4K0bD',
                    'payhip_window',
                    'width=800,height=600,scrollbars=yes'
                );
                
                // بدء مراقبة حالة الدفع
                monitorPaymentStatus();
            };
            
            // إخفاء مؤشر التحميل وإظهار الزر
            setTimeout(() => {
                container.querySelector('.payhip-loading').style.display = 'none';
                container.appendChild(payhipButton);
            }, 1500);
        }
        
        // مراقبة حالة الدفع
        function monitorPaymentStatus() {
            // التحقق كل 5 ثوانٍ
            const checkInterval = setInterval(async () => {
                // هنا يمكنك إضافة منطق للتحقق من حالة الدفع عبر Payhip
                // يمكن استخدام Webhook أو التحقق من قاعدة البيانات
                
                // للمثال، سنستخدم LocalStorage
                const pendingTransaction = localStorage.getItem('pending_transaction');
                
                if (pendingTransaction) {
                    const transaction = JSON.parse(pendingTransaction);
                    
                    // محاكاة نجاح الدفع (في الواقع، ستأتي هذه المعلومات من Paylip)
                    const paymentSuccess = confirmPaymentWithPayhip(transaction.transactionId);
                    
                    if (paymentSuccess) {
                        clearInterval(checkInterval);
                        await processSuccessfulPayment(transaction);
                    }
                }
            }, 5000);
        }
        
        // محاكاة التحقق من Payhip (في الواقع ستستخدم API حقيقي)
        function confirmPaymentWithPaylip(transactionId) {
            // هذا مثال فقط - في الواقع ستستخدم Paylip API
            // يمكنك إعداد Webhook في Paylip لإعلامك عند اكتمال الدفع
            
            // للمثال، سنفترض أن الدفع اكتمل إذا مر أكثر من 10 ثوانٍ
            return localStorage.getItem('paylip_payment_completed') === 'true';
        }
        
        // معالجة الدفع الناجح
        async function processSuccessfulPayment(transaction) {
            const user = await firebaseAuth.getCurrentUser();
            
            if (!user) {
                showMessage('error', 'حدث خطأ في التعرف على المستخدم');
                return;
            }
            
            // تحديث حالة الدفع في Firebase
            const paymentData = {
                method: 'paylip',
                transactionId: transaction.transactionId,
                amount: transaction.amount,
                status: 'completed'
            };
            
            const result = await firebaseAuth.updatePayment(user.uid, paymentData);
            
            if (result.success) {
                showMessage('success', 'تم تفعيل حسابك بنجاح! سيتم توجيهك إلى الكتاب خلال 3 ثوانٍ...');
                
                // تنظيف LocalStorage
                localStorage.removeItem('pending_transaction');
                localStorage.setItem('paylip_payment_completed', 'false');
                
                // التوجيه إلى الكتاب بعد 3 ثوانٍ
                setTimeout(() => {
                    window.location.href = 'book.html';
                }, 3000);
            } else {
                showMessage('error', 'حدث خطأ في تفعيل الحساب: ' + result.error);
            }
        }
        
        // دالة عرض الرسائل
        function showMessage(type, text) {
            const messageDiv = document.getElementById('purchaseMessage');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            
            messageDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // إعداد Webhook افتراضي (للتجربة فقط)
        // في الواقع ستقوم بإعداد Webhook في لوحة تحكم Paylip
        function setupMockWebhook() {
            // محاكاة استقبال تأكيد الدفع من Paylip
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'PAYLIP_PAYMENT_SUCCESS') {
                    localStorage.setItem('paylip_payment_completed', 'true');
                    
                    // إغلاق نافذة Paylip
                    if (window.opener) {
                        window.opener.postMessage({ type: 'PAYMENT_COMPLETED' }, '*');
                        window.close();
                    }
                }
            });
        }
        
        // تهيئة Webhook (للتجربة فقط)
        setupMockWebhook();
    </script>
</body>
</html>